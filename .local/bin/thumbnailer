#!/usr/bin/env bash

if ! [ -f "$1" ]; then
    exit 1
fi

cache="$HOME/.cache/thumbnails"
file="$(realpath "$1")"
mime="$(file -Lb --mime-type "$file")"
thumbnail="$(echo "$file" | base64 -w 999).png"

mkdir -p "$cache"

if [ -f "$cache/$thumbnail" ]; then
    echo "$cache/$thumbnail"
    exit 0
fi

case $mime in
    video/*)    ffmpegthumbnailer -i "$file" -o "$cache/$thumbnail" -s 0 ;;
    image/svg*) rsvg-convert --keep-aspect-ratio --width 768 "$file" -o "$cache/$thumbnail" ;;
    */pdf)      pdftoppm -png -f 1 -r 100 -singlefile "$file" "$(echo $cache/$thumbnail | sed 's/\.png$//')" ;;
    audio/*)    ffmpeg -y -i "$file" -an -vf scale=256:256 "$cache/$thumbnail" ;;
    *) echo "$file"; exit 0 ;;
esac

echo $cache/$thumbnail
