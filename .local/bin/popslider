#!/bin/bash

utility=$1
slider="$1-pop"
action=$2
lockfile="/tmp/${slider}.lock"

if [[ "$slider" == "brightness-pop" ]]; then
    if [[ ${action} == "up" ]]; then
        brightnessctl -q -n9 set +2%
    else
        brightnessctl -q -n9 set 2%-
    fi
    laststate="$(brightnessctl get)"
    eww update current-brightness-state=${laststate}
else 
    if [[ ${action} == "up" ]]; then
        laststate="$(pamixer --get-volume -i 2)"
    else
        laststate="$(pamixer --get-volume -d 2)"
    fi
    eww update current-volume-state=${laststate}
fi

if [[ -f ${lockfile} ]]; then
    echo $(( $(cat ${lockfile})+1 )) > ${lockfile}
    exit 0
fi

echo 1 > ${lockfile}
eww open "${slider}"
lastrun=0

function getstate {
    if [[ "$1" == "brightness-pop" ]]; then
        echo "$(brightnessctl get)"
    else 
        echo "$(pamixer --get-volume)"
    fi
}

while true; do
    currentrun="$(cat ${lockfile})"
    currentstate="$(getstate ${slider})"
    if [ ${currentrun} -eq ${lastrun} ] && [ ${currentstate} -eq ${laststate} ]; then
        eww close "${slider}"
        break
    else
        lastrun=${currentrun}
        laststate=${currentstate}
    fi
    sleep 3
done

rm ${lockfile}
